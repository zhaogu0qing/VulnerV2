# coding:utf8
"""
Created by zhaoguoqing on 18/11/4
"""
from bson import ObjectId
from flask import (
    Blueprint, flash, g, redirect, render_template, request, session, url_for, jsonify, abort
)
from .db import get_db
from .forms import VulnerEditForm

bp = Blueprint('vulner', __name__, url_prefix='/vulner')


@bp.route('/all/page/<int:page_num>', methods=('GET',))
def get_all(page_num=0):
    db = get_db()
    vulners = []
    for idx, v in enumerate(db['cnnvdVulnerability'].find().skip(page_num * 10).limit(10), 1):
        v['idx'] = idx
        v['_id'] = str(v['_id'])
        vulners.append(v)
    return render_template('vulner/showAll.html', vulners=vulners)

@bp.route('/detail/<string:vulner_id>', methods=('GET',))
def get_detail(vulner_id):
    db = get_db()
    vulner = db['cnnvdVulnerability'].find_one({'_id': ObjectId(vulner_id)})
    if not vulner:
        abort(404)
    return render_template('vulner/showDetail.html', vulner=vulner)

@bp.route('/edit/<string:vulner_id>', methods=('GET', 'POST'))
def edit(vulner_id):
    db = get_db()
    form = VulnerEditForm()
    vulner = db['cnnvdVulnerability'].find_one({'_id': ObjectId(vulner_id)})
    if not vulner:
        abort(404)
    if request.method == 'POST' and form.validate_on_submit():
        vulner['title'] = form.title.data
        vulner['CNNVDId'] = form.CNNVDId.data
        vulner['CVEId'] = form.CVEId.data
        vulner['publishTime'] = form.publishTime.data
        vulner['updateTime'] = form.updateTime.data
        vulner['vulnerSource'] = form.vulnerSource.data
        vulner['vulnerLevel'] = form.vulnerLevel.data
        vulner['vulnerType'] = form.vulnerType.data
        vulner['threatType'] = form.threatType.data
        vulner['firm'] = form.firm.data
        vulner['vulnerSummary'] = form.vulnerSummary.data
        vulner['vulnerBulletin'] = form.vulnerBulletin.data
        vulner['vulnerReference'] = form.vulnerReference.data
        vulner['vulnerAffect'] = form.vulnerAffect.data
        vulner['vulnerPatch'] = form.vulnerPatch.data
        db['cnnvdVulnerability'].save(vulner)
        flash("更新成功")
        return redirect(url_for('index'))
    form.title.data = vulner['title']
    form.CNNVDId.data = vulner['CNNVDId']
    form.CVEId.data = vulner['CVEId']
    form.publishTime.data = vulner['publishTime']
    form.updateTime.data = vulner['updateTime']
    form.vulnerSource.data = vulner['vulnerSource']
    form.vulnerLevel.data = vulner['vulnerLevel']
    form.vulnerType.data = vulner['vulnerType']
    form.threatType.data = vulner['threatType']
    form.firm.data = vulner['firm']
    form.vulnerSummary.data = vulner['vulnerSummary']
    form.vulnerBulletin.data = vulner['vulnerBulletin']
    form.vulnerReference.data = vulner['vulnerReference']
    form.vulnerAffect.data = vulner['vulnerAffect']
    form.vulnerPatch.data = vulner['vulnerPatch'] 
    return render_template('vulner/editDetail.html', vulner=vulner, form=form)